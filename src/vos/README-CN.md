# VOS(版本控制对象库)

## 基于持久性内存的存储

DAOS服务具有两层存储：
~~~~
- 用于字节粒度的应用程序数据和元数据的SCM
- 用于批量应用程序数据的NVMe
~~~~

当前的DAOS存储模型涉及每个内核三个DAOS服务器xstream，以及一个映射到NVMe的主要DAOS服务器xstream。DAOS的存储分配可以通过PMDK pmemobj池在SCM上进行分配，也可以用过SPDK Bloib在NVMe上进行分配。

## VOS概念

版本控制对象库通过将VOS池（vpool）`初始化为DAOS池的一个分片，来提供存储目标本地的对象存储`。一个vpool可以为称为容器的多个对象地址空间保存对象。每个vpool在创建时都会获得一个唯一的UID，该ID与DAOS池的UID不同。VOS还维护并提供了一种提取统计信息的方法，例如总空间，可用空间和虚拟池中存在的对象数。

VOS的主要目的是按任意时间顺序捕获和记录对象更新，并将它们集成到可以按需有效遍历的有序纪元历史记录中。通过正确地对冲突的更新进行排序，而不需要对其进行及时序列化，这为并行I / O提供了重大的可伸缩性改进。`例如，如果两个应用程序进程就如何解决给定更新中的冲突达成协议，则它们可以独立编写更新，并确保将在VOS上以正确的顺序解决它们`。

VOS还允许丢弃与给定纪元和过程组关联的所有对象更新。此功能可确保当必须中止DAOS事务时，在为该进程组提交时期并将其变为不可变之前，所有关联的更新都是不可见的。这确保了分布式更新是原子的-即，当提交完成时，所有更新都已应用或被丢弃。

最后，VOS可以汇总对象的时代历史，以回收不可访问的数据使用的空间，并通过简化索引来加快访问速度。例如，当在给定的纪元中将数组对象从0“打孔”到无穷远时，一旦关闭容器，在该纪元之前的最新快照之后更新的所有数据将变得不可访问。

在内部，VOS维护容器UUID的索引，该索引引用存储在特定池中的每个容器。容器本身包含三个索引。第一个是对象索引，用于在服务I / O请求时将对象ID和纪元有效地映射到对象元数据。其他两个索引用于维护活动和已提交的DTX记录，以确保跨多个副本进行有效的更新。

DAOS支持两种类型的值，每种类型都与分发键（DKEY）和属性键（AKEY）相关联：单个值和数组值。DKEY用于放置，确定使用哪个VOS池存储数据。AKEY标识要存储的数据。同时指定DKEY和AKEY的能力为应用程序提供了在DAOS中分发或共置不同值的灵活性。单个值是一个原子值，意味着将其写入AKEY会更新整个值，而读取会整体读取最新的值。数组值是大小相等的记录的索引。对数组值的每次更新仅影响指定的记录，并读取对请求的每个记录索引的最新更新。每个VOS池都维护VOS提供的每个容器层次结构，包括容器，对象，DKEY，AKEY，下面。DAOS API提供了在此基础接口上构建的通用键值和数组抽象。前者将DKEY设置为用户指定的密钥，并使用固定的AKEY。后者使用数组索引的高位来创建DKEY，并使用固定的AKEY，从而在对象布局中的所有VOS池上平均分配数组索引。对于VOS的其余描述，应使用键值和键数组来描述VOS布局，而不是使用这些简化的抽象。换句话说，它们将在单个VOS池中描述DKEY-AKEY-Value。

VOS对象不是显式创建的，而是在第一次写入时通过创建对象元数据并将其引用插入拥有容器的对象索引中而创建的。所有对象更新都会记录每次更新的数据，可以是对象，DKEY，AKEY，单个值或数组值打孔或单个值或数组值的更新。请注意，将数组对象范围的“打孔”记录为归零范围，而不是导致丢弃相关的数组范围或键值。记录了对象，DKEY，AKEY或单个值的输入，因此在以后的时间戳读取时看不到任何数据。这确保了对象的完整版本历史记录仍可访问。但是，DAOS api只允许访问快照中的数据，因此VOS聚合可以主动删除对象，密钥，


DAOS api只允许访问snapshot中的数据。

<a id="7a"></a>
![../../doc/graph/Fig_067.png](../../doc/graph/Fig_067.png "VOS Pool storage layout")

## VOS 索引

对象索引表的值（由OID索引）指向DKEY索引。由DKEY索引的DKEY索引中的值指向AKEY索引。由AKEY索引的AKEY索引中的值指向单值索引或数组索引。纪元引用单个值索引，该索引将返回在纪元或纪元之前插入的最新值。数组值由范围和时期索引，并将返回在该时期可见的范围的部分。

关于对象期望的提示可以编码在对象ID中。例如，对象可以被复制，擦除编码，使用校验和，或者具有整数或词法DKEY和/或AKEY。如果使用整数或词法键，则对象索引按键排序，从而使查询（例如数组大小）更加有效。否则，键由索引中的哈希值排序。对象ID是128位。高32位用于对对象类型和键类型进行编码，而低96位是用户定义的标识符，该标识符对于容器必须是唯一的。

每个对象，dkey和akey都有关联的化身日志。化身日志可以描述为关联实体的创建和冲压事件的有序日志。在该值的路径中检查每个实体的日志，以确保该实体及其值在请求的时间可见。

## Key Value Stores（Single Value）

VOS在持久性内存上提供了一个多版本的并发KV存储，该存储可以动态增长并提供快速的近周期检索和键值枚举。

VOS必须能够在任何时期接受KV对的插入，并且必须能够为任何键值对象上的并发更新和查找提供良好的可伸缩性。KV对象还必须能够支持任何类型和大小的键和值。

### 键值存储支持的操作

VOS支持四种类型的操作，更新、查找、打孔以及枚举。

更新和打孔操作将新密钥添加到KV存储或记录现有密钥的新值。Punch记录特殊值“ punched”（实际上是一个负数），以记录删除键时的纪元。不允许共享同一时期用于同一对象，键，值或范围的更新和操作，并且尝试共享时，VOS将返回错误。

